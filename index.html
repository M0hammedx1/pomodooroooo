<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark" data-color="tomato">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Focus</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&family=Outfit:wght@400;600;800&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Light Mode Default */
            --bg-color: #f4f6f8;
            --surface-color: #ffffff;
            --text-main: #2d3436;
            --text-muted: #868e96;
            --border-color: #e2e8f0;
            --shadow: 0 15px 35px -5px rgba(0,0,0,0.05);
            --modal-bg: rgba(255, 255, 255, 0.85);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --glass-blur: blur(16px);
        }

        /* Dark Mode */
        [data-theme="dark"] {
            --bg-color: #0b0c10;
            --surface-color: #1a1b20;
            --text-main: #f8f9fa;
            --text-muted: #8a9ba8;
            --border-color: #2d3748;
            --shadow: 0 15px 35px -5px rgba(0,0,0,0.5);
            --modal-bg: rgba(11, 12, 16, 0.85);
        }

        /* Premium Themes Config */
        [data-color="tomato"] { --primary: #ff4757; --primary-glow: rgba(255, 71, 87, 0.3); --timer-glow: none; }
        [data-color="sakura"] { --primary: #ff9ff3; --primary-glow: rgba(255, 159, 243, 0.3); --timer-glow: none; }
        [data-color="ocean"] { --primary: #0abde3; --primary-glow: rgba(10, 189, 227, 0.3); --timer-glow: none; }
        [data-color="cyberpunk"] { --primary: #00d2d3; --primary-glow: rgba(0, 210, 211, 0.4); --timer-glow: 0 0 25px var(--primary-glow); }
        [data-color="sunset"] { --primary: #ff9f43; --primary-glow: rgba(255, 159, 67, 0.3); --timer-glow: none; }
        [data-color="monochrome"] { --primary: #8395a7; --primary-glow: rgba(131, 149, 167, 0.3); --timer-glow: none; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg-color); color: var(--text-main);
            font-family: 'Tajawal', sans-serif; height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: var(--transition); overflow: hidden;
            padding: 1rem;
        }

        /* Hardware Accelerated Particles */
        #particles { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 0; overflow: hidden;
        }
        .particle {
            position: absolute; opacity: 0; pointer-events: none;
            will-change: transform, opacity;
        }

        /* Header & Signature */
        .app-header { text-align: center; margin-bottom: 1.5rem; z-index: 1; }
        .app-title {
            font-family: 'Outfit', sans-serif; font-size: clamp(1.8rem, 4vw, 2.5rem); font-weight: 800;
            letter-spacing: 3px; text-transform: uppercase; color: var(--text-main);
            margin-bottom: -5px; line-height: 1;
        }
        .app-signature {
            font-family: 'Dancing Script', cursive; font-size: clamp(1rem, 2.5vw, 1.4rem); color: var(--primary);
            opacity: 0.9; transition: var(--transition);
        }

        /* Main Container */
        .container {
            background: var(--surface-color); padding: clamp(1.5rem, 4vw, 2.5rem); border-radius: 28px;
            box-shadow: var(--shadow); z-index: 1; width: 100%; max-width: 650px;
            text-align: center; border: 1px solid var(--border-color);
            position: relative; backdrop-filter: var(--glass-blur);
            max-height: 85vh; overflow-y: auto; scrollbar-width: none;
        }

        /* Top Bar */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        
        .theme-selector { display: flex; gap: 10px; flex-wrap: wrap; }
        .theme-dot {
            width: 16px; height: 16px; border-radius: 50%; cursor: pointer;
            transition: var(--transition); border: 2px solid transparent;
        }
        .theme-dot:hover { transform: scale(1.3); }
        .theme-dot.active { border-color: var(--text-main); transform: scale(1.2); }
        .td-tomato { background: #ff4757; }
        .td-sakura { background: #ff9ff3; }
        .td-ocean { background: #0abde3; }
        .td-cyberpunk { background: #00d2d3; }
        .td-sunset { background: #ff9f43; }
        .td-monochrome { background: #8395a7; }

        .mode-switch {
            position: relative; width: 48px; height: 26px; flex-shrink: 0;
            background: var(--border-color); border-radius: 30px; cursor: pointer; transition: var(--transition);
        }
        .mode-switch::after {
            content: ''; position: absolute; top: 3px; left: 3px; width: 20px; height: 20px;
            background: var(--text-main); border-radius: 50%; transition: var(--transition);
        }
        [data-theme="dark"] .mode-switch::after { transform: translateX(22px); background: var(--primary); }

        /* Input & Timer */
        .task-input {
            width: 100%; padding: 10px 0; border: none; border-bottom: 2px solid var(--border-color);
            background: transparent; color: var(--text-main); font-size: clamp(1.1rem, 3vw, 1.4rem); font-weight: 500;
            text-align: center; outline: none; transition: var(--transition); margin-bottom: 1.5rem;
        }
        .task-input:focus { border-bottom-color: var(--primary); }
        .task-input::placeholder { color: var(--text-muted); font-weight: 300; }

        .phase-text { font-size: 1rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 3px; font-family: 'Outfit', sans-serif;}
        .timer-display {
            font-size: clamp(4.5rem, 15vw, 7.5rem); font-weight: 800; color: var(--text-main);
            font-family: 'Outfit', sans-serif; font-variant-numeric: tabular-nums;
            margin: 0; transition: var(--transition); line-height: 1.1;
        }
        .timer-display.running { color: var(--primary); text-shadow: var(--timer-glow); }
        .timer-display.flow { color: #00d2d3; text-shadow: 0 0 20px rgba(0, 210, 211, 0.4); }

        /* Controls */
        .controls { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin-top: 1.5rem; }
        .btn {
            background: transparent; color: var(--text-main); border: 2px solid var(--border-color);
            padding: 12px clamp(15px, 4vw, 30px); border-radius: 14px; font-size: clamp(0.9rem, 2vw, 1rem); font-weight: 600;
            cursor: pointer; transition: var(--transition); font-family: 'Outfit', 'Tajawal', sans-serif;
            text-transform: uppercase; letter-spacing: 1px; flex: 1; min-width: 110px;
        }
        .btn-primary { background: var(--text-main); color: var(--surface-color); border-color: var(--text-main); }
        .btn-primary:hover { background: var(--primary); border-color: var(--primary); color: #fff; box-shadow: 0 8px 20px var(--primary-glow); transform: translateY(-2px); }
        .btn:hover:not(.btn-primary) { border-color: var(--text-muted); transform: translateY(-2px); }
        .btn-flow { border-color: #00d2d3; color: var(--text-main); }
        .btn-flow:hover { background: #00d2d3; color: #fff; border-color: #00d2d3; box-shadow: 0 8px 20px rgba(0, 210, 211, 0.4); }

        /* Bottom Links & Modals */
        .bottom-links { margin-top: 1.5rem; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .link-btn {
            background: none; border: none; color: var(--text-muted); font-size: 1rem; font-weight: 500;
            cursor: pointer; transition: var(--transition); text-transform: uppercase; letter-spacing: 1px;
        }
        .link-btn:hover { color: var(--primary); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); backdrop-filter: var(--glass-blur);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: var(--transition); z-index: 100; padding: 1rem;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        
        .modal-content {
            background: var(--surface-color); padding: clamp(1.5rem, 4vw, 2.5rem); border-radius: 24px;
            width: 100%; border: 1px solid var(--border-color); box-shadow: var(--shadow);
            position: relative; transform: translateY(20px) scale(0.95); transition: var(--transition);
        }
        .modal-overlay.active .modal-content { transform: translateY(0) scale(1); }

        .close-btn {
            position: absolute; top: 15px; left: 15px; background: none; border: none;
            color: var(--text-muted); font-size: 1.5rem; cursor: pointer; transition: color 0.2s; z-index: 10; font-family: 'Outfit', sans-serif;
        }
        .close-btn:hover { color: var(--primary); }
        .modal-title { font-size: clamp(1.2rem, 3vw, 1.5rem); margin-bottom: 1.5rem; color: var(--text-main); text-align: right; padding-right: 2rem; font-weight: 700; }

        /* Settings Specific */
        .settings-modal { max-width: 500px; max-height: 90vh; overflow-y: auto; scrollbar-width: none; }
        .setting-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.8rem; border-bottom: 1px solid var(--border-color); }
        .setting-label { display: flex; flex-direction: column; text-align: right; }
        .setting-label span { font-size: 1rem; color: var(--text-main); font-weight: 500; }
        .setting-label small { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }
        
        .setting-input {
            width: 65px; padding: 8px; border-radius: 10px; border: 2px solid var(--border-color);
            background: var(--bg-color); color: var(--text-main); text-align: center; font-family: 'Outfit', sans-serif; font-size: 1rem;
            outline: none; transition: var(--transition);
        }
        .setting-input:focus { border-color: var(--primary); }

        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: var(--text-main); transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); background-color: #fff; }
        .vol-slider { -webkit-appearance: none; width: 100px; height: 4px; border-radius: 5px; background: var(--border-color); outline: none; direction: ltr; }
        .vol-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--primary); cursor: pointer; }

        /* Action Buttons Grid */
        .action-btns-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 1.5rem; }
        .action-btn { background: var(--bg-color); color: var(--text-main); border: 1px solid var(--border-color); padding: 10px; border-radius: 12px; cursor: pointer; font-family: 'Tajawal'; font-weight: 600; transition: var(--transition); }
        .action-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }

        /* Stats Full Screen Modal */
        .stats-modal { max-width: 1100px; height: 85vh; display: flex; flex-direction: column; }
        .stats-content { display: flex; gap: 1.5rem; flex: 1; min-height: 0; }
        .chart-section { flex: 1.2; display: flex; flex-direction: column; background: var(--bg-color); border-radius: 16px; padding: 1rem; min-height: 200px;}
        .history-section { flex: 1; display: flex; flex-direction: column; gap: 1rem; min-height: 0; }
        
        .date-select-container { display: flex; gap: 10px; }
        .date-select {
            flex: 1; padding: 12px; border-radius: 12px; border: 2px solid var(--border-color);
            background: var(--bg-color); color: var(--text-main); font-family: 'Tajawal', sans-serif;
            font-size: 1rem; outline: none; cursor: pointer; font-weight: 500;
        }
        .add-session-btn { background: var(--primary); color: #fff; border: none; border-radius: 12px; padding: 0 15px; cursor: pointer; font-family: 'Tajawal'; font-weight: bold; transition: var(--transition); }
        .add-session-btn:hover { opacity: 0.9; transform: scale(1.05); }

        .sessions-list {
            flex: 1; overflow-y: auto; background: var(--bg-color); border-radius: 16px; padding: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--primary) transparent;
        }
        .session-item { padding: 1rem 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .session-item:last-child { border-bottom: none; }
        .s-info { flex: 1; text-align: right; }
        .s-name { font-weight: 600; color: var(--text-main); font-size: 1rem; word-break: break-word;}
        .s-meta { font-size: 0.85rem; color: var(--text-muted); font-family: 'Outfit', sans-serif; display: inline-block; background: var(--surface-color); padding: 4px 8px; border-radius: 6px; margin-top: 5px;}
        
        .s-actions { display: flex; gap: 8px; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1.1rem; opacity: 0.7; transition: var(--transition); }
        .icon-btn:hover { opacity: 1; transform: scale(1.1); }

        @media (max-width: 768px) { 
            body { overflow-y: auto; height: auto; min-height: 100vh; }
            .stats-content { flex-direction: column; }
            .chart-section { flex: none; height: 250px; }
            .stats-modal { height: 95vh; }
        }

        /* Animations */
        @keyframes driftUp { 0% { transform: translateY(110vh) scale(0.8); opacity: 0; } 20% { opacity: 0.6; } 100% { transform: translateY(-10vh) scale(1.2); opacity: 0; } }
        @keyframes driftDown { 0% { transform: translateY(-10vh); opacity: 0.8; } 100% { transform: translateY(110vh); opacity: 0; } }
        @keyframes leafFall { 0% { transform: translateY(-10vh) rotate(0deg) translateX(0); opacity: 0; } 20% { opacity: 0.8; } 100% { transform: translateY(110vh) rotate(360deg) translateX(50px); opacity: 0; } }
        @keyframes bubbleRise { 0% { transform: translateY(110vh) scale(0.5); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: translateY(-10vh) scale(1.5); opacity: 0; } }
        @keyframes spinDrift { 0% { transform: translateY(110vh) rotate(0deg); opacity: 0; } 20% { opacity: 0.4; } 100% { transform: translateY(-10vh) rotate(180deg); opacity: 0; } }
    </style>
</head>
<body>

    <div id="particles"></div>

    <div class="app-header">
        <div class="app-title">Pomodoro</div>
        <div class="app-signature">By Mohamed Islam</div>
    </div>

    <div class="container">
        <div class="top-bar">
            <div class="theme-selector">
                <div class="theme-dot td-tomato active" onclick="setTheme('tomato')"></div>
                <div class="theme-dot td-sunset" onclick="setTheme('sunset')"></div>
                <div class="theme-dot td-sakura" onclick="setTheme('sakura')"></div>
                <div class="theme-dot td-ocean" onclick="setTheme('ocean')"></div>
                <div class="theme-dot td-cyberpunk" onclick="setTheme('cyberpunk')"></div>
                <div class="theme-dot td-monochrome" onclick="setTheme('monochrome')"></div>
            </div>
            <div class="mode-switch" onclick="toggleDarkMode()"></div>
        </div>

        <input type="text" id="taskInput" class="task-input" dir="auto" placeholder="Ù…Ø§ Ø§Ù„Ø°ÙŠ ØªØ±ÙƒØ² Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø¢Ù†ØŸ">
        
        <div class="phase-text" id="phaseText">Focus</div>
        <div class="timer-display" id="timeDisplay">25:00</div>

        <div class="controls">
            <button class="btn btn-primary" id="startBtn" onclick="toggleTimer()">Start</button>
            <button class="btn btn-flow" id="flowBtn" onclick="toggleFlowMode()">Flow â™¾ï¸</button>
            <button class="btn" onclick="resetTimer()">Reset</button>
        </div>

        <div class="bottom-links">
            <button class="link-btn" onclick="openModal('settingsModal')">Settings</button>
            <button class="link-btn" onclick="openModal('statsModal'); loadFullStats();">Statistics</button>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content settings-modal">
            <button class="close-btn" onclick="closeModal('settingsModal')">âœ•</button>
            <h2 class="modal-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
            
            <div class="setting-group">
                <div class="setting-label"><span>Ø§Ù„ØªØ±ÙƒÙŠØ²</span><small>Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</small></div>
                <input type="number" id="workMins" class="setting-input" value="25" min="1" onchange="updateSettings()">
            </div>
            <div class="setting-group">
                <div class="setting-label"><span>Ø±Ø§Ø­Ø© Ù‚ØµÙŠØ±Ø©</span><small>Ù…Ø¯Ø© Ø§Ù„Ø±Ø§Ø­Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø§Øª</small></div>
                <input type="number" id="shortBreakMins" class="setting-input" value="5" min="1" onchange="updateSettings()">
            </div>
            <div class="setting-group">
                <div class="setting-label"><span>Ø±Ø§Ø­Ø© Ø·ÙˆÙŠÙ„Ø©</span><small>Ù…Ø¯Ø© Ø§Ù„Ø±Ø§Ø­Ø© Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ø¬Ù„Ø³Ø§Øª</small></div>
                <input type="number" id="longBreakMins" class="setting-input" value="15" min="1" onchange="updateSettings()">
            </div>
            <div class="setting-group">
                <div class="setting-label"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</span><small>Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø­Ø© Ø·ÙˆÙŠÙ„Ø©</small></div>
                <input type="number" id="cyclesLimit" class="setting-input" value="4" min="1" onchange="updateSettings()">
            </div>
            <div class="setting-group">
                <div class="setting-label"><span>Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø§Ø­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</span><small>Ø¨Ø¯ÙˆÙ† ØªØ¯Ø®Ù„ Ù…Ù†Ùƒ</small></div>
                <label class="toggle-switch"><input type="checkbox" id="autoBreak" onchange="updateSettings()"><span class="slider"></span></label>
            </div>
            <div class="setting-group">
                <div class="setting-label"><span>Ø¨Ø¯Ø¡ Ø§Ù„ØªØ±ÙƒÙŠØ² ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</span><small>Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø§Ø­Ø©</small></div>
                <label class="toggle-switch"><input type="checkbox" id="autoFocus" onchange="updateSettings()"><span class="slider"></span></label>
            </div>
            <div class="setting-group" style="border-bottom: none;">
                <div class="setting-label"><span>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª</span><small>Ù„Ø¬Ø±Ø³ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</small></div>
                <input type="range" id="alarmVolume" class="vol-slider" min="0" max="1" step="0.1" value="0.5" onchange="testSound()">
            </div>

            <div class="action-btns-grid">
                <button class="action-btn" onclick="exportData()">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ“¤</button>
                <button class="action-btn" onclick="document.getElementById('importFile').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ“¥</button>
                <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="statsModal">
        <div class="modal-content stats-modal">
            <button class="close-btn" onclick="closeModal('statsModal')">âœ•</button>
            <h2 class="modal-title">Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</h2>
            <div class="stats-content">
                <div class="history-section">
                    <div class="date-select-container">
                        <select id="dateSelector" class="date-select" onchange="renderDayDetails()"></select>
                        <button class="add-session-btn" onclick="addManualSession()" title="Ø¥Ø¶Ø§ÙØ© Ø¬Ù„Ø³Ø© ÙŠØ¯ÙˆÙŠØ©">â•</button>
                    </div>
                    <div class="sessions-list" id="sessionsList"></div>
                </div>
                <div class="chart-section">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State Variables
        let timerId = null;
        let isRunning = false;
        let isFlowMode = false; // New Mode
        let currentMode = 'work'; 
        let completedCycles = 0;
        let sessionStartTime = null;
        
        let config = { work: 25 * 60, shortBreak: 5 * 60, longBreak: 15 * 60, cyclesLimit: 4, autoBreak: false, autoFocus: false, volume: 0.5 };
        let timeLeft = config.work;
        let flowSeconds = 0; // Tracks open-ended time

        const timeDisplay = document.getElementById('timeDisplay');
        const startBtn = document.getElementById('startBtn');
        const flowBtn = document.getElementById('flowBtn');
        const phaseText = document.getElementById('phaseText');
        const taskInput = document.getElementById('taskInput');
        let myChart = null;
        const alarmSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        // Particles
        let particleInterval = null;
        let activeParticlesCount = 0;
        const MAX_PARTICLES = 35;
        const particlesContainer = document.getElementById('particles');

        document.addEventListener('DOMContentLoaded', () => {
            loadSavedConfig();
            if(localStorage.getItem('pomoTheme')) setTheme(localStorage.getItem('pomoTheme'));
            if(localStorage.getItem('pomoMode')) document.documentElement.setAttribute('data-theme', localStorage.getItem('pomoMode'));
            updateDisplay();
            initChart();

            document.addEventListener("visibilitychange", () => {
                if (document.hidden && isRunning) clearInterval(particleInterval);
                else if (!document.hidden && isRunning) startParticles();
            });
        });

        // --- Core Functions ---
        function loadSavedConfig() {
            const saved = JSON.parse(localStorage.getItem('pomoConfig'));
            if(saved) config = {...config, ...saved};
            
            document.getElementById('workMins').value = config.work / 60;
            document.getElementById('shortBreakMins').value = config.shortBreak / 60;
            document.getElementById('longBreakMins').value = config.longBreak / 60;
            document.getElementById('cyclesLimit').value = config.cyclesLimit;
            document.getElementById('autoBreak').checked = config.autoBreak;
            document.getElementById('autoFocus').checked = config.autoFocus;
            document.getElementById('alarmVolume').value = config.volume;
            
            if(!isRunning) timeLeft = config.work;
        }

        function updateSettings() {
            config.work = document.getElementById('workMins').value * 60;
            config.shortBreak = document.getElementById('shortBreakMins').value * 60;
            config.longBreak = document.getElementById('longBreakMins').value * 60;
            config.cyclesLimit = document.getElementById('cyclesLimit').value;
            config.autoBreak = document.getElementById('autoBreak').checked;
            config.autoFocus = document.getElementById('autoFocus').checked;
            config.volume = document.getElementById('alarmVolume').value;
            localStorage.setItem('pomoConfig', JSON.stringify(config));
            if(!isRunning && !isFlowMode) resetTimer();
        }

        function testSound() {
            config.volume = document.getElementById('alarmVolume').value;
            alarmSound.volume = config.volume; alarmSound.currentTime = 0; alarmSound.play();
            localStorage.setItem('pomoConfig', JSON.stringify(config));
        }

        function toggleDarkMode() {
            const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('pomoMode', next);
            if(myChart) loadFullStats(); 
        }

        function setTheme(color) {
            document.documentElement.setAttribute('data-color', color);
            localStorage.setItem('pomoTheme', color);
            document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
            document.querySelector(`.td-${color}`).classList.add('active');
            if(isRunning) { stopParticles(); startParticles(); }
            if(myChart) loadFullStats();
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function triggerNotification(title, body) {
            if ("Notification" in window && Notification.permission === "granted") new Notification(title, { body: body });
        }

        // --- Standard Timer Logic ---
        function toggleTimer() {
            if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();
            
            if(isFlowMode) { alert('Ø£Ù†Øª Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¯ÙÙ‚ (Flow Mode)ØŒ ÙŠØ±Ø¬Ù‰ Ø¥ÙŠÙ‚Ø§ÙÙ‡ Ø£ÙˆÙ„Ø§Ù‹! â¹ï¸'); return; }

            if (isRunning) {
                clearInterval(timerId); isRunning = false;
                startBtn.innerText = "Resume"; timeDisplay.classList.remove('running');
                stopParticles();
            } else {
                if(currentMode === 'work' && !sessionStartTime) sessionStartTime = new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
                isRunning = true;
                startBtn.innerText = "Pause"; timeDisplay.classList.add('running');
                timerId = setInterval(tick, 1000);
                startParticles();
            }
        }

        // --- NEW: Flow Mode Logic â™¾ï¸ ---
        function toggleFlowMode() {
            if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();
            
            if (isRunning && !isFlowMode) { alert('Ø£ÙˆÙ‚Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¯ÙÙ‚! â³'); return; }

            if (isFlowMode) {
                // Stop Flow
                clearInterval(timerId); isRunning = false; isFlowMode = false;
                timeDisplay.classList.remove('flow', 'running');
                flowBtn.innerText = "Flow â™¾ï¸"; flowBtn.classList.remove('btn-primary');
                stopParticles();
                
                // Save accumulated time
                const minutesFocused = Math.floor(flowSeconds / 60);
                if(minutesFocused > 0) {
                    saveSession(taskInput.value.trim() || 'Ø¬Ù„Ø³Ø© ØªØ¯ÙÙ‚ Ø­Ø± (Flow)', minutesFocused, sessionStartTime);
                    triggerNotification("Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹!", `Ù‚Ø¶ÙŠØª ${minutesFocused} Ø¯Ù‚ÙŠÙ‚Ø© ÙÙŠ Ø­Ø§Ù„Ø© ØªØ±ÙƒÙŠØ² Ø¹Ù…ÙŠÙ‚.`);
                }
                resetTimer();
            } else {
                // Start Flow
                isFlowMode = true; isRunning = true; flowSeconds = 0;
                sessionStartTime = new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
                flowBtn.innerText = "Stop â¹ï¸"; flowBtn.classList.add('btn-primary');
                startBtn.innerText = "Start"; // Reset standard btn text
                timeDisplay.classList.add('flow');
                phaseText.innerText = "Flow Mode (Deep Focus)";
                timerId = setInterval(tick, 1000);
                startParticles();
            }
        }

        function tick() {
            if (isFlowMode) {
                flowSeconds++; updateDisplay();
            } else {
                if (timeLeft > 0) { timeLeft--; updateDisplay(); } 
                else handleComplete();
            }
        }

        function handleComplete() {
            clearInterval(timerId); isRunning = false; stopParticles(); timeDisplay.classList.remove('running');
            alarmSound.volume = config.volume; alarmSound.play().catch(e=>console.log(e));
            
            if (currentMode === 'work') {
                saveSession(taskInput.value.trim() || 'Ø¬Ù„Ø³Ø© ØªØ±ÙƒÙŠØ²', config.work / 60, sessionStartTime);
                sessionStartTime = null; completedCycles++;
                
                if (completedCycles % config.cyclesLimit === 0) {
                    currentMode = 'longBreak'; timeLeft = config.longBreak; phaseText.innerText = "Long Break";
                    triggerNotification("Ø±Ø§Ø­Ø© Ø·ÙˆÙŠÙ„Ø©!", `Ø£Ù†Ø¬Ø²Øª ${config.cyclesLimit} Ø¯ÙˆØ±Ø§Øª.`);
                } else {
                    currentMode = 'shortBreak'; timeLeft = config.shortBreak; phaseText.innerText = `Short Break (${completedCycles}/${config.cyclesLimit})`;
                    triggerNotification("ÙˆÙ‚Øª Ø§Ù„Ø±Ø§Ø­Ø©!", `Ø¹Ø§Ø´! Ø§Ø³ØªØ±Ø­ Ù‚Ù„ÙŠÙ„Ø§Ù‹.`);
                }
                startBtn.innerText = "Start Break";
                if(config.autoBreak) toggleTimer();
            } else {
                currentMode = 'work'; timeLeft = config.work; phaseText.innerText = "Focus"; startBtn.innerText = "Start Focus";
                triggerNotification("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø±Ø§Ø­Ø©", `Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ².`);
                if(config.autoFocus) toggleTimer();
            }
            updateDisplay();
        }

        function resetTimer() {
            clearInterval(timerId); isRunning = false; isFlowMode = false;
            stopParticles(); timeDisplay.classList.remove('running', 'flow');
            flowBtn.innerText = "Flow â™¾ï¸"; flowBtn.classList.remove('btn-primary');
            currentMode = 'work'; timeLeft = config.work; flowSeconds = 0; sessionStartTime = null;
            phaseText.innerText = "Focus"; startBtn.innerText = "Start"; updateDisplay();
        }

        function updateDisplay() {
            let totalSeconds = isFlowMode ? flowSeconds : timeLeft;
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const s = (totalSeconds % 60).toString().padStart(2, '0');
            
            const formattedTime = h > 0 ? `${h}:${m}:${s}` : `${m}:${s}`;
            timeDisplay.innerText = formattedTime; 
            document.title = `${formattedTime} - ${isFlowMode ? 'Flow' : 'Focus'}`;
        }

        // --- Particles Engine ---
        function startParticles() {
            clearInterval(particleInterval);
            const theme = document.documentElement.getAttribute('data-color');
            let freq = (theme === 'cyberpunk' || isFlowMode) ? 250 : 600; 
            
            particleInterval = setInterval(() => {
                if (document.hidden || activeParticlesCount >= MAX_PARTICLES) return;
                
                const p = document.createElement('div');
                p.classList.add('particle');
                p.style.left = Math.random() * 100 + 'vw';
                activeParticlesCount++;
                
                const duration = Math.random() * 3 + 4;

                if (isFlowMode) {
                    p.style.width = Math.random() * 5 + 3 + 'px'; p.style.height = p.style.width;
                    p.style.background = '#00d2d3'; p.style.borderRadius = '50%'; p.style.boxShadow = '0 0 12px #00d2d3';
                    p.style.animation = `driftUp ${duration - 1}s ease-in forwards`;
                } else {
                    switch(theme) {
                        case 'tomato':
                            p.style.width = Math.random() * 8 + 6 + 'px'; p.style.height = p.style.width;
                            p.style.background = '#ff4757'; p.style.borderRadius = '50%';
                            p.style.animation = `driftUp ${duration}s ease-in forwards`;
                            break;
                        case 'sunset':
                            p.style.width = Math.random() * 6 + 3 + 'px'; p.style.height = p.style.width;
                            p.style.background = '#ff9f43'; p.style.borderRadius = '50%'; p.style.boxShadow = '0 0 8px #ff9f43';
                            p.style.animation = `driftUp ${duration}s ease-in forwards`;
                            break;
                        case 'sakura':
                            p.style.width = '14px'; p.style.height = '14px';
                            p.style.background = '#ff9ff3'; p.style.borderRadius = '50% 0 50% 50%';
                            p.style.animation = `leafFall ${duration + 1}s linear forwards`;
                            break;
                        case 'ocean':
                            p.style.width = Math.random() * 10 + 5 + 'px'; p.style.height = p.style.width;
                            p.style.border = '2px solid #0abde3'; p.style.borderRadius = '50%'; p.style.background = 'transparent';
                            p.style.animation = `bubbleRise ${duration - 1}s ease-in forwards`;
                            break;
                        case 'cyberpunk':
                            p.style.width = '2px'; p.style.height = Math.random() * 40 + 15 + 'px';
                            p.style.background = '#00d2d3'; p.style.boxShadow = '0 0 10px #00d2d3';
                            p.style.animation = `driftDown ${duration - 2}s linear forwards`;
                            break;
                        case 'monochrome':
                            p.style.width = '10px'; p.style.height = '10px';
                            p.style.background = '#8395a7';
                            p.style.animation = `spinDrift ${duration}s linear forwards`;
                            break;
                    }
                }
                particlesContainer.appendChild(p);
                setTimeout(() => { p.remove(); activeParticlesCount--; }, duration * 1000);
            }, freq);
        }
        function stopParticles() { clearInterval(particleInterval); particlesContainer.innerHTML = ''; activeParticlesCount = 0; }

        // --- NEW: Data Management (Export/Import/Edit) ---
        function getToday() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

        function saveSession(task, duration, startTime) {
            let data = JSON.parse(localStorage.getItem('pomoDataAdvanced')) || {}; const today = getToday();
            if(!data[today]) data[today] = { totalMins: 0, sessions: [] };
            data[today].totalMins += duration;
            data[today].sessions.unshift({ name: task, duration: duration, time: startTime || new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'}) });
            localStorage.setItem('pomoDataAdvanced', JSON.stringify(data));
        }

        // Add Manual Session
        function addManualSession() {
            let targetDate = document.getElementById('dateSelector').value || getToday();
            let taskName = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© / Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:", "Ø¬Ù„Ø³Ø© Ù…Ø³Ø¬Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹");
            if (!taskName) return;
            let durationStr = prompt("Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚:", "25");
            let duration = parseInt(durationStr);
            if (isNaN(duration) || duration <= 0) return alert("Ù…Ø¯Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©!");

            let data = JSON.parse(localStorage.getItem('pomoDataAdvanced')) || {};
            if(!data[targetDate]) data[targetDate] = { totalMins: 0, sessions: [] };
            
            data[targetDate].totalMins += duration;
            data[targetDate].sessions.unshift({
                name: taskName,
                duration: duration,
                time: new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})
            });
            localStorage.setItem('pomoDataAdvanced', JSON.stringify(data));
            loadFullStats();
        }

        // Edit Session
        function editSession(dateStr, index) {
            let data = JSON.parse(localStorage.getItem('pomoDataAdvanced'));
            let session = data[dateStr].sessions[index];
            
            let newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©:", session.name);
            if (newName === null) return;
            let newDurStr = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚:", session.duration);
            let newDur = parseInt(newDurStr);
            if (isNaN(newDur) || newDur < 0) return alert("Ù…Ø¯Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©!");

            data[dateStr].totalMins -= session.duration; // Remove old
            session.name = newName;
            session.duration = newDur;
            data[dateStr].totalMins += newDur; // Add new
            
            localStorage.setItem('pomoDataAdvanced', JSON.stringify(data));
            loadFullStats();
        }

        // Delete Session
        function deleteSession(dateStr, index) {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ ğŸ—‘ï¸")) return;
            let data = JSON.parse(localStorage.getItem('pomoDataAdvanced'));
            
            data[dateStr].totalMins -= data[dateStr].sessions[index].duration;
            data[dateStr].sessions.splice(index, 1);
            
            if(data[dateStr].sessions.length === 0) delete data[dateStr]; // Clean up empty days
            
            localStorage.setItem('pomoDataAdvanced', JSON.stringify(data));
            loadFullStats();
        }

        // Export Data
        function exportData() {
            const data = localStorage.getItem('pomoDataAdvanced') || '{}';
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'pomodoro_backup.json';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Import Data
        function importData(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedJson = JSON.parse(e.target.result);
                    localStorage.setItem('pomoDataAdvanced', JSON.stringify(importedJson));
                    alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰');
                    if(document.getElementById('statsModal').classList.contains('active')) loadFullStats();
                } catch(err) {
                    alert('Ø¹ÙÙˆØ§Ù‹ØŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­! âŒ');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // --- UI Rendering ---
        function loadFullStats() {
            const data = JSON.parse(localStorage.getItem('pomoDataAdvanced')) || {};
            const selector = document.getElementById('dateSelector'); selector.innerHTML = '';
            const dates = Object.keys(data).sort((a,b) => new Date(b) - new Date(a)); 
            
            if(dates.length === 0) {
                selector.innerHTML = `<option value="${getToday()}">Ø§Ù„ÙŠÙˆÙ… (${getToday()})</option>`;
                document.getElementById('sessionsList').innerHTML = '<div style="text-align:center; color:var(--text-muted); margin-top:2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø©ØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„Ø¢Ù†! Ø£Ùˆ Ø£Ø¶Ù Ø¬Ù„Ø³Ø© ÙŠØ¯ÙˆÙŠØ©.</div>';
                updateChart({}, []); return;
            }

            dates.forEach(dateStr => {
                const opt = document.createElement('option'); opt.value = dateStr;
                opt.innerText = new Date(dateStr).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                selector.appendChild(opt);
            });
            renderDayDetails(); updateChart(data, dates.slice(0, 7).reverse()); 
        }

        function renderDayDetails() {
            const data = JSON.parse(localStorage.getItem('pomoDataAdvanced')) || {};
            const selectedDate = document.getElementById('dateSelector').value;
            const list = document.getElementById('sessionsList'); list.innerHTML = '';
            
            if(!data[selectedDate]) return;

            const summaryDiv = document.createElement('div');
            summaryDiv.style.marginBottom = '1rem'; summaryDiv.style.paddingBottom = '0.8rem'; summaryDiv.style.borderBottom = '1px solid var(--border-color)';
            summaryDiv.innerHTML = `<div style="font-size: 1.1rem; font-weight: bold;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ±ÙƒÙŠØ²: <span style="color: var(--primary); font-family: Outfit; font-size:1.3rem;">${data[selectedDate].totalMins}</span> Ø¯Ù‚ÙŠÙ‚Ø©</div>`;
            list.appendChild(summaryDiv);

            data[selectedDate].sessions.forEach((s, index) => {
                const item = document.createElement('div'); item.className = 'session-item';
                item.innerHTML = `
                    <div class="s-info">
                        <div class="s-name">${s.name}</div>
                        <div class="s-meta">${s.duration} Min â€¢ ${s.time}</div>
                    </div>
                    <div class="s-actions">
                        <button class="icon-btn" onclick="editSession('${selectedDate}', ${index})" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                        <button class="icon-btn" onclick="deleteSession('${selectedDate}', ${index})" title="Ø­Ø°Ù">âŒ</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Ø¯Ù‚Ø§Ø¦Ù‚', data: [], borderRadius: 6 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, grid: { color: 'rgba(150,150,150,0.1)' }, border: {display: false} }, x: { grid: { display: false }, border: {display: false} } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateChart(data, recentDates) {
            const primaryColor = getComputedStyle(document.body).getPropertyValue('--primary').trim() || '#ff4757';
            Chart.defaults.color = getComputedStyle(document.body).getPropertyValue('--text-muted').trim() || '#868e96';
            Chart.defaults.font.family = 'Tajawal';

            const labels = []; const chartData = [];
            recentDates.forEach(d => { labels.push(new Date(d).toLocaleDateString('ar-EG', { weekday: 'short' })); chartData.push(data[d].totalMins); });
            
            myChart.data.labels = labels; myChart.data.datasets[0].data = chartData; myChart.data.datasets[0].backgroundColor = primaryColor;
            myChart.update();
        }
    </script>
</body>
</html>
